


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > ElementCreator</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">kweb</a>
</div>

<h1>Coverage Summary for Class: ElementCreator (kweb)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">ElementCreator</td>
<td class="coverageStat">
  <span class="percent">
    41.2%
  </span>
  <span class="absValue">
    (7/17)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    77.8%
  </span>
  <span class="absValue">
    (28/36)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    65.8%
  </span>
  <span class="absValue">
    (50/76)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    65.7%
  </span>
  <span class="absValue">
    (331/504)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ElementCreator$cleanup$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ElementCreator$closeOnCleanup$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ElementCreator$Companion</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ElementCreator$element$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (12/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ElementCreator$element$1$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ElementCreator$element$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ElementCreator$element$id$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (6/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ElementCreator$elementScope$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ElementCreator$kval$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ElementCreator$kvar$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    40.7%
  </span>
  <span class="absValue">
    (11/27)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    77.8%
  </span>
  <span class="absValue">
    (28/36)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    63.2%
  </span>
  <span class="absValue">
    (55/87)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    62.8%
  </span>
  <span class="absValue">
    (355/565)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package kweb
&nbsp;
&nbsp;import kotlinx.coroutines.CoroutineScope
&nbsp;import kotlinx.coroutines.Dispatchers
&nbsp;import kotlinx.coroutines.cancel
&nbsp;import kotlinx.serialization.json.JsonObject
&nbsp;import kotlinx.serialization.json.JsonPrimitive
&nbsp;import kweb.html.BodyElement
&nbsp;import kweb.html.HeadElement
&nbsp;import kweb.plugins.KwebPlugin
&nbsp;import kweb.state.CloseReason
&nbsp;import kweb.state.KVal
&nbsp;import kweb.state.KVar
&nbsp;import kweb.util.KWebDSL
&nbsp;import kweb.util.json
&nbsp;import mu.KLogging
&nbsp;import java.util.*
&nbsp;import java.util.concurrent.ConcurrentLinkedQueue
&nbsp;import java.util.concurrent.atomic.AtomicInteger
&nbsp;import kotlin.reflect.KClass
&nbsp;
&nbsp;typealias Cleaner = () -&gt; Unit
&nbsp;
&nbsp;/**
&nbsp; * Responsible for creating new DOM elements, and cleaning up [Cleaner]s, [KVar]s, and other
&nbsp; * related objects when DOM elements are deleted.
&nbsp; *
&nbsp; * [ElementCreator] is typically used as a [receiver](https://stackoverflow.com/a/45875492)
&nbsp; * for element creation functions like [p] or [element].
&nbsp; */
<b class="fc">&nbsp;@KWebDSL</b>
&nbsp;open class ElementCreator&lt;out PARENT_TYPE : Element&gt;(
<b class="fc">&nbsp;    val element: PARENT_TYPE,</b>
<b class="fc">&nbsp;    val parentCreator: ElementCreator&lt;*&gt;? = element.creator,</b>
<b class="fc">&nbsp;    val insertBefore: String? = null</b>
&nbsp;)  {
&nbsp;
<b class="fc">&nbsp;    companion object : KLogging()</b>
&nbsp;
&nbsp;    @Volatile
&nbsp;    private var cleanupListeners: MutableCollection&lt;Cleaner&gt;? = null
&nbsp;
&nbsp;    @Volatile
&nbsp;    private var isCleanedUp = false
&nbsp;
<b class="fc">&nbsp;    val elementsCreatedCount: Int get() = elementsCreatedCountAtomic.get()</b>
<b class="fc">&nbsp;    private val elementsCreatedCountAtomic = AtomicInteger(0)</b>
&nbsp;
<b class="fc">&nbsp;    val browser: WebBrowser get() = element.browser</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Create a new element, specifying its [tag](https://www.javatpoint.com/html-tags) and
&nbsp;     * [attributes](https://www.javatpoint.com/html-attributes).
&nbsp;     *
&nbsp;     * Tag-specific functions like [p], [select], and others call this function and should
&nbsp;     * be used in preference to it if available.
&nbsp;     *
&nbsp;     * @param tag The HTML tag, eg. &quot;p&quot;, &quot;select&quot;, &quot;a&quot;, etc
&nbsp;     * @param attributes The HTML element&#39;s attributes
&nbsp;     * @param namespace If non-null elements will be created with [Document.createElementNS()](https://developer.mozilla.org/en-US/docs/Web/API/Document/createElementNS)
&nbsp;     *                  with the specified namespace. If null then Kweb will use [Document.createElement](https://developer.mozilla.org/en-US/docs/Web/API/Document/createElement).
&nbsp;     */
<b class="fc">&nbsp;    fun element(tag: String, attributes: Map&lt;String, JsonPrimitive&gt; = attr, namespace: String? = null, new: (ElementCreator&lt;*&gt;.(Element) -&gt; Unit)? = null): Element {</b>
&nbsp;
<b class="fc">&nbsp;        val mutAttributes = HashMap(attributes)</b>
&nbsp;
<b class="fc">&nbsp;        val id: String = mutAttributes.computeIfAbsent(&quot;id&quot;) { JsonPrimitive(&quot;K&quot; + browser.generateId()) }.content</b>
<b class="fc">&nbsp;        val htmlDoc = browser.htmlDocument.get()</b>
<b class="fc">&nbsp;        val createElementStatement = when (namespace) {</b>
<b class="pc">&nbsp;            null -&gt; &quot;document.createElement(tag);&quot;</b>
<b class="nc">&nbsp;            else -&gt; &quot;document.createElementNS(\&quot;${namespace}\&quot;, tag);&quot;</b>
&nbsp;        }
<b class="fc">&nbsp;        when {</b>
<b class="fc">&nbsp;            htmlDoc != null -&gt; {</b>
<b class="pc">&nbsp;                val parentElement = when (element) {</b>
<b class="fc">&nbsp;                    is HeadElement -&gt; htmlDoc.head()</b>
<b class="fc">&nbsp;                    is BodyElement -&gt; htmlDoc.body()</b>
<b class="fc">&nbsp;                    else -&gt; htmlDoc.getElementById(element.id)</b>
<b class="nc">&nbsp;                } ?: error(&quot;Can&#39;t find element with id ${element.id}&quot;)</b>
<b class="fc">&nbsp;                val jsElement =</b>
<b class="fc">&nbsp;                    if (insertBefore != null) {</b>
<b class="fc">&nbsp;                        val ne = htmlDoc.createElement(tag)</b>
<b class="fc">&nbsp;                        htmlDoc.getElementById(insertBefore)!!.before(ne)</b>
<b class="fc">&nbsp;                        ne</b>
&nbsp;                    } else {
<b class="fc">&nbsp;                        parentElement.appendElement(tag)</b>
&nbsp;                    }
<b class="fc">&nbsp;                for ((k, v) in mutAttributes) {</b>
<b class="fc">&nbsp;                    jsElement.attr(k, v.content)</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="pc">&nbsp;            element.browser.isCatchingOutbound() != null -&gt; {</b>
&nbsp;                //language=JavaScript
<b class="fc">&nbsp;                val createElementJs = &quot;&quot;&quot;</b>
&nbsp;                    console.log(&quot;Creating new element&quot;)
&nbsp;                    let tag = {};
&nbsp;                    let attributes = {};
&nbsp;                    let myId = {};
&nbsp;                    let parentId = {};
&nbsp;                    let insertBefore = {};
&nbsp;                    console.log(&quot;insertBefore = &quot; + insertBefore)
<b class="fc">&nbsp;                    let newEl = $createElementStatement</b>
&nbsp;                    newEl.setAttribute(&quot;id&quot;, myId);
&nbsp;                    for (const key in attributes) {
&nbsp;                        if ( key !== &quot;id&quot;) {
&nbsp;                            newEl.setAttribute(key, attributes[key]);
&nbsp;                        }
&nbsp;                    }
&nbsp;                    let parentElement = document.getElementById(parentId);
&nbsp;                    let startNode = document.getElementById(insertBefore)
&nbsp;                    
&nbsp;                    if (insertBefore !== undefined) {
&nbsp;                        parentElement.insertBefore(newEl, startNode)
&nbsp;                    } else {
&nbsp;                        parentElement.appendChild(newEl);
&nbsp;                    }
<b class="fc">&nbsp;                &quot;&quot;&quot;.trimIndent()</b>
<b class="fc">&nbsp;                browser.callJsFunction(</b>
<b class="fc">&nbsp;                    createElementJs, JsonPrimitive(tag), JsonObject(mutAttributes), id.json,</b>
<b class="fc">&nbsp;                    JsonPrimitive(element.id), JsonPrimitive(insertBefore ?: &quot;&quot;), JsonPrimitive(elementsCreatedCount)</b>
&nbsp;                )
&nbsp;            }
&nbsp;
&nbsp;            else -&gt; {
&nbsp;                //The way I have written this function, instead of attributes.get(), we now use attributes[].
&nbsp;                //language=JavaScript
<b class="nc">&nbsp;                val createElementJs = &quot;&quot;&quot;</b>
&nbsp;                    console.log(&quot;Creating new element in other place&quot;)
&nbsp;                    let tag = {};
&nbsp;                    let attributes = {};
&nbsp;                    let myId = {};
&nbsp;                    let parentId = {};
&nbsp;                    let insertBefore = {};
&nbsp;                    let newEl = document.createElement(tag);
&nbsp;                    if (attributes[&quot;id&quot;] === undefined) {
&nbsp;                        newEl.setAttribute(&quot;id&quot;, myId);
&nbsp;                    }
&nbsp;                    for (const key in attributes) {
&nbsp;                            newEl.setAttribute(key, attributes[key]);
&nbsp;                    }
&nbsp;                    let parentElement = document.getElementById(parentId);
&nbsp;                    let startNode = document.getElementById(insertBefore)
&nbsp;                    
&nbsp;                    if (insertBefore !== undefined) {
&nbsp;                        parentElement.insertBefore(newEl, startNode)
&nbsp;                    } else {
&nbsp;                        parentElement.appendChild(newEl);
&nbsp;                    }
<b class="nc">&nbsp;                &quot;&quot;&quot;.trimIndent()</b>
<b class="nc">&nbsp;                element.browser.callJsFunction(</b>
<b class="nc">&nbsp;                    createElementJs, tag.json, JsonObject(mutAttributes), id.json,</b>
<b class="nc">&nbsp;                    element.id.json, JsonPrimitive(insertBefore ?: &quot;&quot;), JsonPrimitive(elementsCreatedCount)</b>
&nbsp;                )
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        val newElement = Element(element.browser, this, tag = tag, id = id)</b>
<b class="fc">&nbsp;        elementsCreatedCountAtomic.incrementAndGet()</b>
<b class="fc">&nbsp;        for (plugin in element.browser.kweb.plugins) {</b>
<b class="fc">&nbsp;            plugin.elementCreationHook(newElement)</b>
&nbsp;        }
<b class="fc">&nbsp;        onCleanup(withParent = false) {</b>
<b class="fc">&nbsp;            logger.debug { &quot;Deleting element ${newElement.id}&quot; }</b>
<b class="fc">&nbsp;            newElement.deleteIfExists()</b>
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        if (new != null) {</b>
<b class="nc">&nbsp;            newElement.new { new(newElement) }</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return newElement</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Specify that a specific plugin be provided in [Kweb.plugins], throws an exception if not.
&nbsp;     */
<b class="nc">&nbsp;    fun require(vararg plugins: KClass&lt;out KwebPlugin&gt;) = element.browser.require(*plugins)</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Specify a listener to be called when this element is removed from the DOM.
&nbsp;     *
&nbsp;     * @param withParent If `true` this cleaner will be called if this element is cleaned up, or if
&nbsp;     *                   any ancestor element of this ElementCreator is cleaned up.  Otherwise it will
&nbsp;     *                   only be cleaned up if this ElementCreator is cleaned up specifically.
&nbsp;     *
&nbsp;     *                   As a rule-of-thumb, use &#39;true&#39; for anything except deleting DOM elements.
&nbsp;     */
&nbsp;    fun onCleanup(withParent: Boolean, f: Cleaner) {
<b class="fc">&nbsp;        if (withParent) {</b>
<b class="fc">&nbsp;            parentCreator?.onCleanup(true, f)</b>
&nbsp;        }
<b class="fc">&nbsp;        if (cleanupListeners == null)</b>
<b class="fc">&nbsp;            cleanupListeners = ConcurrentLinkedQueue()</b>
&nbsp;
<b class="pc">&nbsp;        cleanupListeners?.add(f)</b>
&nbsp;    }
&nbsp;
&nbsp;    fun cleanup() {
&nbsp;        // TODO: Warn if called twice?
<b class="pc">&nbsp;        if (!isCleanedUp) {</b>
<b class="fc">&nbsp;            isCleanedUp = true</b>
<b class="fc">&nbsp;            try {</b>
<b class="fc">&nbsp;                cleanupListeners?.forEach { it() }</b>
<b class="nc">&nbsp;            } catch (e: Exception) {</b>
<b class="nc">&nbsp;                logger.warn(e) { &quot;Error while cleaning up ElementCreator&quot; }</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Close this AutoCloseable when this ElementCreator is cleaned up.
&nbsp;     */
&nbsp;    fun closeOnCleanup(closeable: AutoCloseable) {
<b class="nc">&nbsp;        onCleanup(withParent = true) {</b>
<b class="nc">&nbsp;            closeable.close()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    // text() Deprecated because these may create confusion about whether element properties
&nbsp;    // are set on the Element or the ElementCreator
&nbsp;    @Deprecated(&quot;Use element.text() instead&quot;, ReplaceWith(&quot;element.text(text)&quot;))
&nbsp;    fun text(text: String) {
<b class="nc">&nbsp;        this.element.text(text)</b>
&nbsp;    }
&nbsp;
&nbsp;    @Deprecated(&quot;Use element.text() instead&quot;, ReplaceWith(&quot;element.text(text)&quot;))
&nbsp;    fun text(text: KVal&lt;String&gt;) {
<b class="nc">&nbsp;        this.element.text(text)</b>
&nbsp;    }
&nbsp;
&nbsp;    @Deprecated(&quot;Use element {} instead (as of v0.12.8)&quot;, ReplaceWith(&quot;element(receiver)&quot;, &quot;kweb.ElementCreator.element&quot;))
&nbsp;    fun attr(receiver : (PARENT_TYPE).() -&gt; Unit) {
<b class="nc">&nbsp;        receiver(element)</b>
&nbsp;    }
&nbsp;
&nbsp;    @Deprecated(&quot;Use element instead (as of v0.12.8)&quot;, ReplaceWith(&quot;element&quot;, &quot;kweb.ElementCreator.element&quot;))
<b class="nc">&nbsp;    val parent get() = element</b>
&nbsp;
&nbsp;    @Deprecated(&quot;div { element { set(\&quot;foo\&quot;, \&quot;bar\&quot;)} } ===&gt; div { it.set(\&quot;foo\&quot;, \&quot;bar\&quot;) }&quot;,
&nbsp;        ReplaceWith(&quot;receiver(element)&quot;)
&nbsp;    )
&nbsp;    fun element(receiver : (PARENT_TYPE).() -&gt; Unit) {
<b class="nc">&nbsp;        receiver(element)</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Create a new [KVar], and call [KVar.close()] when this ElementCreator is cleaned up.
&nbsp;     */
&nbsp;    fun &lt;T&gt; kvar(initialValue: T): KVar&lt;T&gt; {
<b class="nc">&nbsp;        val kv = KVar(initialValue)</b>
<b class="nc">&nbsp;        onCleanup(withParent = true) {</b>
<b class="nc">&nbsp;            kv.close(CloseReason(&quot;ElementCreator cleaned up&quot;))</b>
&nbsp;        }
<b class="nc">&nbsp;        return kv</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Create a new [KVar], and call [KVar.close()] when this ElementCreator is cleaned up.
&nbsp;     */
&nbsp;    fun &lt;T&gt; kval(initialValue: T): KVal&lt;T&gt; {
<b class="nc">&nbsp;        val kv = KVal(initialValue)</b>
<b class="nc">&nbsp;        onCleanup(withParent = true) {</b>
<b class="nc">&nbsp;            kv.close(CloseReason(&quot;ElementCreator cleaned up&quot;))</b>
&nbsp;        }
<b class="nc">&nbsp;        return kv</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Creates a CoroutineScope that will be cancelled when this ElementCreator is cleaned up.
&nbsp;     */
&nbsp;    @SinceKotlin(&quot;1.1.1&quot;)
&nbsp;    fun elementScope(): CoroutineScope {
<b class="nc">&nbsp;        val scope = CoroutineScope(Dispatchers.IO)</b>
<b class="nc">&nbsp;        onCleanup(withParent = true) {</b>
<b class="nc">&nbsp;            scope.cancel()</b>
&nbsp;        }
<b class="nc">&nbsp;        return scope</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2022-11-19 16:04</div>
</div>
</body>
</html>
