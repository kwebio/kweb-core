


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > RenderEachKt</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">kweb.state</a>
</div>

<h1>Coverage Summary for Class: RenderEachKt (kweb.state)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">RenderEachKt</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (32/32)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (236/236)
  </span>
</td>
</tr>
  <tr>
    <td class="name">RenderEachKt$renderEach$1$1$fragment$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (6/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">RenderEachKt$renderEach$1$2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (5/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">RenderEachKt$renderEach$1$handle$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    77.8%
  </span>
  <span class="absValue">
    (14/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    90%
  </span>
  <span class="absValue">
    (27/30)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    92.4%
  </span>
  <span class="absValue">
    (232/251)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">RenderEachKt$renderEach$insertItem$newFragment$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (6/6)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (8/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    81.8%
  </span>
  <span class="absValue">
    (18/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    95.4%
  </span>
  <span class="absValue">
    (62/65)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    96.2%
  </span>
  <span class="absValue">
    (485/504)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package kweb.state
&nbsp;
&nbsp;import kotlinx.serialization.json.JsonPrimitive
&nbsp;import kweb.Element
&nbsp;import kweb.ElementCreator
&nbsp;import kweb.span
&nbsp;
&nbsp;
&nbsp;/**
&nbsp; * Similar to [render], but renders a list of items, and updates the DOM when the list changes.
&nbsp; *
&nbsp; * While [render] could be used for this with a `KVal&lt;List&lt;String&gt;&gt;`, this method is far more efficient
&nbsp; * because it only updates the DOM when the list changes, rather than re-rendering the entire list every time.
&nbsp; */
&nbsp;fun &lt;ITEM : Any, EL : Element&gt; ElementCreator&lt;EL&gt;.renderEach(
&nbsp;    observableList: ObservableList&lt;ITEM&gt;,
&nbsp;    itemRenderer: ElementCreator&lt;Element&gt;.(ITEM) -&gt; Unit
&nbsp;) {
&nbsp;
&nbsp;    //a wrapper made of 2 empty spans around the list of items that renderEach will draw
&nbsp;    //This is needed to be able to use insertBefore on the end span to add items to the end of the list.
<b class="fc">&nbsp;    val listFragment = RenderFragment(</b>
<b class="fc">&nbsp;        span().classes(RenderSpanNames.listStartMarkerClassName).id,</b>
<b class="fc">&nbsp;        span().classes(RenderSpanNames.listEndMarkerClassName).id</b>
&nbsp;    )
&nbsp;
&nbsp;    fun insertItem(position: Int, newItem: ITEM,
&nbsp;                   renderHandles: ArrayList&lt;RenderHandle&lt;ITEM&gt;&gt;) {
<b class="fc">&nbsp;        val nextElementRenderMarkerStartId: String = if (position == renderHandles.size) {</b>
<b class="fc">&nbsp;            listFragment.endId</b>
&nbsp;        } else {
<b class="fc">&nbsp;            renderHandles[position].renderFragment.startId</b>
&nbsp;        }
<b class="fc">&nbsp;        val itemElementCreator =</b>
<b class="fc">&nbsp;            ElementCreator&lt;Element&gt;(this.element, this, nextElementRenderMarkerStartId)</b>
<b class="fc">&nbsp;        val kvar = KVar(newItem)</b>
<b class="fc">&nbsp;        val newFragment = itemElementCreator.render(kvar) { item -&gt;</b>
<b class="fc">&nbsp;            itemRenderer(item)</b>
&nbsp;        }
<b class="fc">&nbsp;        renderHandles.add(position, RenderHandle(newFragment, kvar))</b>
&nbsp;    }
&nbsp;
&nbsp;    fun &lt;ITEM : Any&gt; deleteItem(position: Int, renderHandles: ArrayList&lt;RenderHandle&lt;ITEM&gt;&gt;) {
<b class="fc">&nbsp;        val renderHandleToRemove = renderHandles[position].renderFragment</b>
<b class="fc">&nbsp;        renderHandles.removeAt(position)</b>
<b class="fc">&nbsp;        browser.callJsFunction(&quot;&quot;&quot;</b>
&nbsp;            var start_id = {};
&nbsp;            var end_id = {};
&nbsp;            var start_element = document.getElementById(start_id);
&nbsp;            var end_element = document.getElementById(end_id);
&nbsp;            var parent = start_element.parentNode;
&nbsp;            while (start_element.nextSibling != end_element) {
&nbsp;                parent.removeChild(start_element.nextSibling);
&nbsp;            }
&nbsp;            parent.removeChild(start_element);
&nbsp;            parent.removeChild(end_element);
<b class="fc">&nbsp;            &quot;&quot;&quot;.trimIndent(), JsonPrimitive(renderHandleToRemove.startId),</b>
<b class="fc">&nbsp;            JsonPrimitive(renderHandleToRemove.endId)</b>
&nbsp;        )
<b class="fc">&nbsp;        renderHandleToRemove.delete()</b>
&nbsp;    }
&nbsp;
&nbsp;    fun moveItemClientSide(itemStartMarker : String, itemEndMarker : String, newPosMarker : String) {
&nbsp;        //This JavaScript takes all elements from one start span to another, denoted by startMarker and endMarker,
&nbsp;        //and inserts them before the element that&#39;s ID is passed to the &#39;newPos&#39; variable.
&nbsp;        //language=JavaScript
<b class="fc">&nbsp;        val moveItemCode = &quot;&quot;&quot;</b>
&nbsp;            var startMarker = document.getElementById({});
&nbsp;            var endMarker = document.getElementById({});
&nbsp;            var elementsToMove = [];
&nbsp;            var currentElement = startMarker.nextSibling;
&nbsp;            while(currentElement !== endMarker) {
&nbsp;                elementsToMove.push(currentElement);
&nbsp;                currentElement = currentElement.nextSibling;
&nbsp;            }
&nbsp;            var newPos = document.getElementById({});
&nbsp;            var listParent = startMarker.parentNode;
&nbsp;            listParent.insertBefore(startMarker, newPos);
&nbsp;            listParent.insertBefore(endMarker, newPos);
&nbsp;            elementsToMove.forEach(function (item){
&nbsp;                listParent.insertBefore(item, endMarker);
&nbsp;            });
<b class="fc">&nbsp;            &quot;&quot;&quot;.trimIndent()</b>
<b class="fc">&nbsp;        browser.callJsFunction(moveItemCode, JsonPrimitive(itemStartMarker),</b>
<b class="fc">&nbsp;            JsonPrimitive(itemEndMarker), JsonPrimitive(newPosMarker)</b>
&nbsp;        )
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    ElementCreator&lt;Element&gt;(this.element, this.parentCreator, insertBefore = listFragment.endId).apply {</b>
&nbsp;
&nbsp;        //These renderFragments must be kept in sync with the items in observableList that they&#39;re rendering
<b class="fc">&nbsp;        val renderHandles = ArrayList&lt;RenderHandle&lt;ITEM&gt;&gt;()</b>
&nbsp;
<b class="fc">&nbsp;        synchronized(renderHandles) {</b>
&nbsp;            //render the initial observableList to the DOM storing the Handles in renderHandles
<b class="fc">&nbsp;            for (item in observableList.getItems()) {</b>
<b class="fc">&nbsp;                val kvar = KVar(item)</b>
<b class="fc">&nbsp;                val fragment = render(kvar) { fragItem -&gt;</b>
<b class="fc">&nbsp;                    itemRenderer(fragItem)</b>
&nbsp;                }
<b class="fc">&nbsp;                renderHandles += RenderHandle(fragment, kvar)</b>
&nbsp;            }
<b class="fc">&nbsp;        }</b>
&nbsp;
<b class="fc">&nbsp;        val handle = observableList.addListener { changes -&gt;</b>
<b class="fc">&nbsp;            synchronized(renderHandles) {</b>
&nbsp;                // TODO: Consider replacing change in changes with, &quot;mods in modifications&quot;, to remove confusion between change, and Modification.Change
<b class="fc">&nbsp;                for (change in changes) {</b>
&nbsp;                    // Apply change to DOM using renderHandles, and update renderHandles to keep it in sync with observableList
<b class="fc">&nbsp;                    when (change) {</b>
<b class="fc">&nbsp;                        is ObservableList.Modification.Change -&gt; {</b>
<b class="fc">&nbsp;                            renderHandles[change.position].kvar.value = KVar(change.newItem).value</b>
&nbsp;                        }
<b class="fc">&nbsp;                        is ObservableList.Modification.Deletion -&gt; {</b>
<b class="fc">&nbsp;                            deleteItem(change.position, renderHandles)</b>
&nbsp;                        }
<b class="fc">&nbsp;                        is ObservableList.Modification.Insertion -&gt; {</b>
<b class="fc">&nbsp;                            insertItem(change.position, change.item, renderHandles)</b>
&nbsp;                        }
<b class="pc">&nbsp;                        is ObservableList.Modification.Move -&gt; {</b>
<b class="pc">&nbsp;                            if (change.oldPosition == change.newPosition) {</b>
<b class="nc">&nbsp;                                continue</b>
&nbsp;                            }
<b class="fc">&nbsp;                            if (change.oldPosition &gt; change.newPosition) {</b>
<b class="fc">&nbsp;                                moveItemClientSide(renderHandles[change.oldPosition].renderFragment.startId,</b>
<b class="fc">&nbsp;                                    renderHandles[change.oldPosition].renderFragment.endId,</b>
<b class="fc">&nbsp;                                    renderHandles[change.newPosition].renderFragment.startId)</b>
<b class="fc">&nbsp;                                renderHandles.add(change.newPosition, RenderHandle(renderHandles[change.oldPosition].renderFragment, renderHandles[change.oldPosition].kvar))</b>
<b class="fc">&nbsp;                                renderHandles.removeAt(change.oldPosition+1)</b>
&nbsp;                            }
&nbsp;                            else { //change.newPosition &gt; change.oldPosition
<b class="fc">&nbsp;                                val newRenderHandle = RenderHandle(renderHandles[change.oldPosition].renderFragment, renderHandles[change.oldPosition].kvar)</b>
<b class="pc">&nbsp;                                val startId = if (change.newPosition == renderHandles.size-1) {</b>
<b class="fc">&nbsp;                                    listFragment.endId</b>
&nbsp;                                } else {
<b class="nc">&nbsp;                                    renderHandles[change.newPosition+1].renderFragment.startId</b>
&nbsp;                                }
<b class="fc">&nbsp;                                moveItemClientSide(renderHandles[change.oldPosition].renderFragment.startId,</b>
<b class="fc">&nbsp;                                    renderHandles[change.oldPosition].renderFragment.endId,</b>
<b class="fc">&nbsp;                                    startId)</b>
<b class="pc">&nbsp;                                if (change.newPosition == renderHandles.size-1) {</b>
<b class="fc">&nbsp;                                    renderHandles.add(newRenderHandle)</b>
&nbsp;                                } else {
<b class="nc">&nbsp;                                    renderHandles.add(change.newPosition+1, newRenderHandle)</b>
&nbsp;                                }
<b class="fc">&nbsp;                                renderHandles.removeAt(change.oldPosition)</b>
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
<b class="fc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        onCleanup(true) {</b>
<b class="fc">&nbsp;            observableList.removeListener(handle)</b>
&nbsp;        }
<b class="fc">&nbsp;    }</b>
&nbsp;}
&nbsp;
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2022-11-21 16:33</div>
</div>
</body>
</html>
