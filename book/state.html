<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Observer Pattern &amp; State - The Kweb User Manual</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="User manual for the Kweb web framework">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="gettingstarted.html"><strong aria-hidden="true">2.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="dom.html"><strong aria-hidden="true">3.</strong> DOM Basics</a></li><li class="chapter-item expanded "><a href="events.html"><strong aria-hidden="true">4.</strong> Event Handling</a></li><li class="chapter-item expanded "><a href="state.html" class="active"><strong aria-hidden="true">5.</strong> Observer Pattern & State</a></li><li class="chapter-item expanded "><a href="routing.html"><strong aria-hidden="true">6.</strong> URL Routing</a></li><li class="chapter-item expanded "><a href="style.html"><strong aria-hidden="true">7.</strong> CSS & Style</a></li><li class="chapter-item expanded "><a href="components.html"><strong aria-hidden="true">8.</strong> Components</a></li><li class="chapter-item expanded "><a href="js.html"><strong aria-hidden="true">9.</strong> JavaScript Interop</a></li><li class="chapter-item expanded "><a href="speed.html"><strong aria-hidden="true">10.</strong> Speed & Efficiency</a></li><li class="chapter-item expanded "><a href="faq.html"><strong aria-hidden="true">11.</strong> FAQ</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Kweb User Manual</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/kwebio/kweb-core" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/kwebio/kweb-core/edit/master/docs/src/state.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rendering-state"><a class="header" href="#rendering-state">Rendering State</a></h1>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#the-kvar-class">The KVar Class</a></li>
<li><a href="#kvars-and-the-dom">KVars and the DOM</a></li>
<li><a href="#binding-a-kvar-to-an-input-elements-value">Binding a KVar to an input element's value</a></li>
<li><a href="#rendering-state-to-a-dom-fragment">Rendering state to a DOM fragment</a></li>
<li><a href="#rendering-lists-with-rendereach">Rendering lists with renderEach</a></li>
<li><a href="#extracting-data-class-properties">Extracting data class properties</a></li>
<li><a href="#reversible-mapping">Reversible mapping</a></li>
</ul>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>A Kweb app is a function that maps state on the server to the DOM in the user's web browser. Once this 
mapping is defined, you can change the state and the browser will update automatically.</p>
<h2 id="the-kvar-class"><a class="header" href="#the-kvar-class">The KVar Class</a></h2>
<p>A <a href="https://docs.kweb.io/api/kweb-core/kweb.state/-k-var/index.html">KVar</a>
is an observable container. It contains a single typed object, which can change over time, similar to an 
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/AtomicReference.html">AtomicReference</a>. 
You can add listeners to a KVar to be notified immediately when it changes.</p>
<p>For example:</p>
<pre><code class="language-kotlin">val counter = KVar(0)
</code></pre>
<p>Here we create a counter of type <em>KVar&lt;Int&gt;</em> initialized with the
value 0.</p>
<p>We can also read and modify the value of a KVar:</p>
<pre><code class="language-kotlin">println(&quot;Counter value ${counter.value}&quot;)
counter.value = 1
println(&quot;Counter value ${counter.value}&quot;)
counter.value++
println(&quot;Counter value ${counter.value}&quot;)
</code></pre>
<p>Will print:</p>
<pre><code class="language-text">Counter value 0
Counter value 1
Counter value 2
</code></pre>
<p>KVars support powerful mapping semantics to create new KVars:</p>
<pre><code class="language-kotlin">val counterDoubled = counter.map { it * 2 }
counter.value = 5
println(&quot;counter: ${counter.value}, doubled: ${counterDoubled.value}&quot;)
counter.value = 6
println(&quot;counter: ${counter.value}, doubled: ${counterDoubled.value}&quot;)
</code></pre>
<p>Will print:</p>
<pre><code class="language-text">counter: 5, doubled: 10
counter: 6, doubled: 12
</code></pre>
<p>Note that <code>counterDoubled</code> updates automatically, because mapped KVars listen to the original for changes.</p>
<p>The <code>KVar</code> class is a subclass of <a href="https://docs.kweb.io/api/kweb-core/kweb.state/-k-val/index.html">KVal</a>, 
which is a read-only version of <code>KVar</code>.</p>
<p><strong>Note:</strong> KVars should only be used to store values that are themselves immutable, such as an Int, String, or a 
Kotlin <a href="https://kotlinlang.org/docs/reference/data-classes.html">data class</a> with immutable parameters.</p>
<h2 id="kvars-and-the-dom"><a class="header" href="#kvars-and-the-dom">KVars and the DOM</a></h2>
<p>Within the Kotlin DSL you can use the <code>kvar()</code> function to create a <code>KVar</code>. This has the advantage of calling
<code>KVar.close()</code> when this DOM fragment is cleaned up which will free up resources, and avoids having to import 
the <code>KVar</code> class.</p>
<pre><code class="language-kotlin">Kweb(port = 2135) {
    doc.body {
        val name = kvar(&quot;John&quot;)
        li().text(name)
    }
}
</code></pre>
<p>The neat part is that if the value of <em>name</em> changes, the DOM element
text will update automatically. It may help to think of this as a way of
&quot;unwrapping&quot; a KVar.</p>
<p>Numerous other functions on
<a href="https://jitpack.io/com/github/kwebio/core/0.3.15/javadoc/io.kweb.dom.element/-element/index.html">Elements</a>
support KVars in a similar manner, including
<a href="https://jitpack.io/com/github/kwebio/core/0.3.15/javadoc/io.kweb.dom.element/-element/inner-h-t-m-l.html">innerHtml()</a>
and
<a href="https://jitpack.io/com/github/kwebio/core/0.3.15/javadoc/io.kweb.dom.element/-element/set-attribute.html">setAttribute()</a>.</p>
<h2 id="binding-a-kvar-to-an-input-elements-value"><a class="header" href="#binding-a-kvar-to-an-input-elements-value">Binding a KVar to an input element's value</a></h2>
<p>For &lt;input&gt; elements you can set the value to a KVar, which will
connect them bidirectionally.</p>
<p>Any changes to the KVar will be reflected in realtime in the browser,
and similarly any changes in the browser by the user will be reflected
immediately in the KVar, for example:</p>
<pre><code class="language-kotlin">Kweb(port = 2395) {
    doc.body {
        p().text(&quot;What is your name?&quot;)
        val input = input(type = InputType.text)
        input.value = KVar(&quot;Peter Pan&quot;)
        val greeting = input.value.map { name -&gt; &quot;Hi $name!&quot; }
        p().text(greeting)
    }
}
</code></pre>
<p>This will also work for <code>&lt;option&gt;</code> and <code>&lt;textarea&gt;</code> elements which also have values.</p>
<p>See also:
<a href="https://docs.kweb.io/api/kweb-core/kweb/-value-element/index.html#-178499702%2FProperties%2F769193423">ValueElement.value</a></p>
<h2 id="rendering-state-to-a-dom-fragment"><a class="header" href="#rendering-state-to-a-dom-fragment">Rendering state to a DOM fragment</a></h2>
<p>But what if you want to do more than just modify a single element based
on a KVar, what if you want to modify a whole tree of elements?</p>
<p>This is where the <a href="https://docs.kweb.io/api/kweb-core/kweb.state/render.html">render</a> function comes in:</p>
<pre><code class="language-kotlin">val list = KVar(listOf(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;))

Kweb(port = 16097) {
    doc.body {
        render(list) { rList -&gt;
            ul {
                for (item in rList) {
                    li().text(item)
                }
            }
        }
    }
}
</code></pre>
<p>Here, if we were to change the list:</p>
<pre><code class="language-kotlin">list.value = listOf(&quot;four&quot;, &quot;five&quot;, &quot;six&quot;)
</code></pre>
<p>Then the relevant part of the DOM will be redrawn instantly.</p>
<p>The simplicity of this mechanism may disguise how powerful it is, since
render {} blocks can be nested, it's possible to be very selective
about what parts of the DOM must be modified in response to changes in
state.</p>
<p><strong>Note:</strong> Kweb will only re-render a DOM fragment if the value of the KVar
actually changes so you should avoid &quot;unwrapping&quot; KVars with a
<em>render()</em> or <em>.text()</em> call before you need to.</p>
<p>The <a href="https://javadoc.jitpack.io/com/github/kwebio/core/0.3.15/javadoc/io.kweb.state/-k-val/map.html">KVal.map {}</a>
function is a powerful tool for manipulating KVals and KVars without unwrapping them.</p>
<h2 id="rendering-lists-with-rendereach"><a class="header" href="#rendering-lists-with-rendereach">Rendering lists with renderEach</a></h2>
<p>The <code>renderEach()</code> function allows you to render a list of items, while 
automatically updating the rendered DOM in response to changes in the list. </p>
<p>While a <code>KVar&lt;List&lt;FooBar&gt;&gt;</code> could be passed to <code>render()</code>, it would be
very inefficient because the entire list would be re-rendered every time.
<code>renderEach()</code> will only re-render the elements that have changed.</p>
<p>The items are provided in an <a href="https://docs.kweb.io/api/kweb-core/kweb.state/index.html#183886605%2FClasslikes%2F769193423">ObservableList</a>, which implements the 
<code>MutableList</code> interface.</p>
<pre><code class="language-kotlin">doc.body {
    data class Pet(val name : String, val age : Int)

    val obsList = ObservableList(listOf(
        Pet(&quot;Sammy&quot;, 7),
        Pet(&quot;Halley&quot;, 5),
        Pet(&quot;Buddy&quot;, 3)
    ))
    table {
        renderEach(obsList) { item -&gt;
            tr {
                td().text(item.name)
                td().text(item.age.toString())
            }
        }
    }
    obsList.add(1, Pet(&quot;Bella&quot;, 2))
    obsList.removeAt(2)
    obsList.move(0, 1)
    obsList[0] = Pet(&quot;Joe&quot;, 1)
}
</code></pre>
<h2 id="extracting-data-class-properties"><a class="header" href="#extracting-data-class-properties">Extracting data class properties</a></h2>
<p>If your KVar contains a <a href="https://kotlinlang.org/docs/reference/data-classes.html">data
class</a> then you
can use Kvar.property() to create a KVar from one of its properties
which will update the original KVar if changed:</p>
<pre><code class="language-kotlin">data class User(val name: String)

val user = KVar(User(&quot;Ian&quot;))
val name = user.property(User::name)
name.value = &quot;John&quot;
println(user) // Will print: KVar(User(name = &quot;John&quot;))
</code></pre>
<h2 id="reversible-mapping"><a class="header" href="#reversible-mapping">Reversible mapping</a></h2>
<p>If you check the type of <em>counterDoubled</em>, you'll notice that it's a
<em>KVal</em> rather than a <em>KVar</em>, meaning it cannot be modified directly, only by
changing the <em>KVar</em> it was mapped from. </p>
<p>So this will result in a compilation error:</p>
<pre><code class="language-kotlin">val counter = KVar(0)
val counterDoubled = counter.map { it * 2 }
counterDoubled.value = 20 // &lt;--- This won't compile
</code></pre>
<p>The <em>KVar</em> class has a second
<a href="https://docs.kweb.io/api/kweb-core/kweb.state/-k-var/map.html">map()</a>
function which takes a <em>ReversibleFunction</em> implementation. This version
of <em>map</em> will produce a KVar which can be modified, as follows:</p>
<pre><code class="language-kotlin">val counterDoubled = counter.map(object : ReversibleFunction&lt;Int, Int&gt;(&quot;doubledCounter&quot;) {
    override fun invoke(from: Int) = from * 2
    override fun reverse(original: Int, change: Int) = change / 2
})
counter.value = 5
println(&quot;counter: ${counter.value}, doubled: ${counterDoubled.value}&quot;)
// output: counter: 5, doubled: 10

counterDoubled.value = 12 // &lt;-- Couldn't do this with a KVal
println(&quot;counter: ${counter.value}, doubled: ${counterDoubled.value}&quot;)
// output: counter: 6, doubled: 12
</code></pre>
<p>If the mapped <em>Kvar</em> is changed the original KVar it was mapped from will also
change.</p>
<p>Reversible mappings are an advanced feature that you only need if you
want the mapped value to be a mutable KVar. Most of the time the simple
<a href="https://docs.kweb.io/api/kweb-core/kweb.state/-k-val/map.html">KVal.map {}</a>
function is what you need.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="events.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="routing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="events.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="routing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
